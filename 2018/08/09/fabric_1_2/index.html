<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="docker multi-stage build support在 fabric 1.2 版本中，fabric-tool 的 dockerfile 采用了 docker 17.05 版本之后支持的 多阶段构建 特性介绍          Service Discovery在 Fabric 1.2 之前，SDK 需要保存很多节点信息，包括节点地址，MSP，TLS，需要记得每个合约的背书策略等。这些信">
<meta property="og:type" content="article">
<meta property="og:title" content="Fabric 1.2 release 新特性">
<meta property="og:url" content="http://yoursite.com/2018/08/09/fabric_1_2/index.html">
<meta property="og:site_name" content="Drip">
<meta property="og:description" content="docker multi-stage build support在 fabric 1.2 版本中，fabric-tool 的 dockerfile 采用了 docker 17.05 版本之后支持的 多阶段构建 特性介绍          Service Discovery在 Fabric 1.2 之前，SDK 需要保存很多节点信息，包括节点地址，MSP，TLS，需要记得每个合约的背书策略等。这些信">
<meta property="og:updated_time" content="2018-09-28T02:52:40.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fabric 1.2 release 新特性">
<meta name="twitter:description" content="docker multi-stage build support在 fabric 1.2 版本中，fabric-tool 的 dockerfile 采用了 docker 17.05 版本之后支持的 多阶段构建 特性介绍          Service Discovery在 Fabric 1.2 之前，SDK 需要保存很多节点信息，包括节点地址，MSP，TLS，需要记得每个合约的背书策略等。这些信">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Fabric 1.2 release 新特性</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/08/10/fabric_cc/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/08/08/ecc/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/08/09/fabric_1_2/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/08/09/fabric_1_2/&text=Fabric 1.2 release 新特性"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/08/09/fabric_1_2/&title=Fabric 1.2 release 新特性"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/08/09/fabric_1_2/&is_video=false&description=Fabric 1.2 release 新特性"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Fabric 1.2 release 新特性&body=Check out this article: http://yoursite.com/2018/08/09/fabric_1_2/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/08/09/fabric_1_2/&title=Fabric 1.2 release 新特性"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/08/09/fabric_1_2/&title=Fabric 1.2 release 新特性"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/08/09/fabric_1_2/&title=Fabric 1.2 release 新特性"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/08/09/fabric_1_2/&title=Fabric 1.2 release 新特性"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/08/09/fabric_1_2/&name=Fabric 1.2 release 新特性&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-multi-stage-build-support"><span class="toc-number">1.</span> <span class="toc-text">docker multi-stage build support</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Service-Discovery"><span class="toc-number">2.</span> <span class="toc-text">Service Discovery</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Private-Data"><span class="toc-number">3.</span> <span class="toc-text">Private Data</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新的-event-机制"><span class="toc-number">4.</span> <span class="toc-text">新的 event 机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新的-transaction-flow"><span class="toc-number">5.</span> <span class="toc-text">新的 transaction flow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ACL-access-control-list"><span class="toc-number">6.</span> <span class="toc-text">ACL access control list</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Channel-Configuration-（configtx）"><span class="toc-number">7.</span> <span class="toc-text">Channel Configuration （configtx）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#业务-Channel-创建流程"><span class="toc-number">8.</span> <span class="toc-text">业务 Channel 创建流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MSP-类型"><span class="toc-number">9.</span> <span class="toc-text">MSP 类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#背书策略"><span class="toc-number">10.</span> <span class="toc-text">背书策略</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Idemix"><span class="toc-number">11.</span> <span class="toc-text">Idemix</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Block-的结构"><span class="toc-number">12.</span> <span class="toc-text">Block 的结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#peer-收到-Proposal-后是如何验证交易的发起方是否在-channel-对应的-orgs-中"><span class="toc-number">13.</span> <span class="toc-text">peer 收到 Proposal 后是如何验证交易的发起方是否在 channel 对应的 orgs 中</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#财团-Consortium-中的成员作用"><span class="toc-number">14.</span> <span class="toc-text">财团 Consortium 中的成员作用</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Fabric 1.2 release 新特性
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Drip</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-08-09T02:30:30.000Z" itemprop="datePublished">2018-08-09</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="docker-multi-stage-build-support"><a href="#docker-multi-stage-build-support" class="headerlink" title="docker multi-stage build support"></a>docker multi-stage build support</h1><p>在 fabric 1.2 版本中，fabric-tool 的 dockerfile 采用了 docker 17.05 版本之后支持的 <code>多阶段构建</code> 特性<br><a href="https://yeasy.gitbooks.io/docker_practice/image/multistage-builds.html" target="_blank" rel="external">介绍</a>         </p>
<h1 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h1><p>在 Fabric 1.2 之前，SDK 需要保存很多节点信息，包括节点地址，MSP，TLS，需要记得每个合约的背书策略等。这些信息是静态的，会随着网络的动态变化而过时。<br>由于在 SDK 维护这些信息比较麻烦，现在支持向 peer 请求获取相关信息（借助 gossip），即 Service Discovery。提供一下四种查询：     </p>
<ol>
<li>Configuration query: Returns the MSPConfig of all organizations in the channel along with the orderer endpoints of the channel.</li>
<li>Peer membership query: Returns the peers that have joined the channel.</li>
<li>Endorsement query: Returns an endorsement descriptor for given chaincode(s) in a channel.</li>
<li>Local peer membership query: Returns the local membership information of the peer that responds to the query. By default the client needs to be an administrator for the peer to respond to this query.        </li>
</ol>
<p>在 core.yaml 中新增的配置，决定该 peer 是否开启 ServiceDiscovery 服务<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># The discovery service is used by clients to query information about peers,</span></div><div class="line">   <span class="comment"># such as - which peers have joined a certain channel, what is the latest</span></div><div class="line">   <span class="comment"># channel config, and most importantly - given a chaincode and a channel,</span></div><div class="line">   <span class="comment"># what possible sets of peers satisfy the endorsement policy.</span></div><div class="line"><span class="attr">   discovery:</span></div><div class="line"><span class="attr">       enabled:</span> <span class="literal">true</span></div><div class="line">       <span class="comment"># Whether the authentication cache is enabled or not.</span></div><div class="line"><span class="attr">       authCacheEnabled:</span> <span class="literal">true</span></div><div class="line">       <span class="comment"># The maximum size of the cache, after which a purge takes place</span></div><div class="line"><span class="attr">       authCacheMaxSize:</span> <span class="number">1000</span></div><div class="line">       <span class="comment"># The proportion (0 to 1) of entries that remain in the cache after the cache is purged due to overpopulation</span></div><div class="line"><span class="attr">       authCachePurgeRetentionRatio:</span> <span class="number">0.75</span></div><div class="line">       <span class="comment"># Whether to allow non-admins to perform non channel scoped queries.</span></div><div class="line">       <span class="comment"># When this is false, it means that only peer admins can perform non channel scoped queries.</span></div><div class="line"><span class="attr">       orgMembersAllowedAccess:</span> <span class="literal">false</span></div></pre></td></tr></table></figure></p>
<h1 id="Private-Data"><a href="#Private-Data" class="headerlink" title="Private Data"></a>Private Data</h1><p>在合约的初始化时，现在可以提供 –collections-config 参数，表示 collections 配置文件的地址。该 json 文件中可以包含该合约内多个 collection 配置，每个 collection 可以有自己独立的权限配置：    </p>
<ol>
<li><p>name，表示该 collection 的名称。</p>
</li>
<li><p>policy，语法等同于背书策略，例如 “OR(‘Org1MSP.member’, ‘Org2MSP.member’)”。</p>
</li>
<li><p>maxPeerCount，模拟执行后，需要给符合 policy 的 peer 节点 gossip 该私有 collection 数据，该项限制发送的 peer 节点的最大数量。如果该项设置为 0，则表示在模拟执行阶段，不会发送 private 数据给其他的 peer。但是最好不要这样设置，因为如果该 Endorser peer 在 模拟执行阶段 与 commit 阶段中间挂掉了，那这些 private 数据就会无法发出去，导致其他 peer 无法拉取到私密数据。 因此该项配置是为了 private 数据的冗余性和可靠性。</p>
</li>
<li><p>requiredPeerCount，上一步 gossip 私有 collection 数据是需要等待 ack 的，这里表示需要获得的最少 ack 数量。如果在一定时间内未获得该数量的响应，则会在模拟执行阶段返回对应错误，防止进入进入后续的 commit 阶段。最好不要配置为 0，因为可能会导致 private 数据的丢失。</p>
</li>
<li><p>blockToLive，私有数据是没有账本的，而是写入对应的 side db 中。由于在业务中，私有数据为了不留痕迹，需要在使用过后被自动清除这样的需求，该参数表示经过几个 block 后从数据库中删除对应 collection 数据。设置为 0 则表示不删除。</p>
</li>
</ol>
<p>合约中，通过调用 <code>PutPrivateData(collection_name,key,value)</code> 和 <code>GetPrivateData(collection_name,key)</code> 读写私有数据，如果没有权限会返回对应的 error       </p>
<p><code>peer.gossip.pvtData.pullRetryThreshold</code>：可以在 <code>core.yaml</code> 中配置该项，如果 peer 在该项时间内获取到对应的私密数据，则 commit 该条交易至账本并存储私密数据到 side db 中。否则，只 commit 该条交易至账本，这会导致后续 Endorser 如果用到该条数据会返回错误信息。        </p>
<p><code>transient store</code>：每个 peer 本地都有这样一个对象。由于私密数据是在模拟执行时（Endorser）发送的，而这条交易并一定真正被执行，因此此时发送的 gossip 私密数据被收到后，会放置在该对象中，待需要时取出。这里的数据过期也会被清除，通过配置 <code>core.yaml</code> 中的 <code>peer.gossip.pvtData.transientstoreMaxBlockRetention</code>             </p>
<p>cis 中的 <code>transient</code> 字段： 由于不仅仅是交易的结果会上链，交易的请求参数也会上链。为了防止请求参数中私密数据部分上链，可以将对应的数据放在该字段中（不会上链），合约中通过 <code>GetTransient()</code> 接口获取该数据。      </p>
<h1 id="新的-event-机制"><a href="#新的-event-机制" class="headerlink" title="新的 event 机制"></a>新的 event 机制</h1><p>自从 Fabric 1.1 开始，提供了两个新的服务供 sdk 实现 channel based event 机制。即 <code>Deliver</code> 和 <code>DeliverFiltered</code> 这两个 peer 上新的接口。大致原理是从 peer 上拉取对应 channel 的账本，然后 sdk 本地解析区块，提取其中的 <code>ChaincodeActionPayload</code> 和 <code>FilteredChaincodeAction</code> 字段内容。<br>相较之前的 eventhub 机制，优点是可以 replay event（从指定区块开始拉取，因此也不容易因为网络等原因错过 event），可以被其他 org 的身份访问（只要满足该通道的 reader 权限即可）。      </p>
<p>旧的 event 机制会 deprecated      </p>
<h1 id="新的-transaction-flow"><a href="#新的-transaction-flow" class="headerlink" title="新的 transaction flow"></a>新的 transaction flow</h1><h1 id="ACL-access-control-list"><a href="#ACL-access-control-list" class="headerlink" title="ACL access control list"></a>ACL access control list</h1><p>ACL 定义在 Application 中，即用户的业务通道中<br>策略分为：Policy 以及 ImplicitMeta<br>ImplicitMeta 是 Policy 的组合：<code>&lt;ALL|ANY|MAJORITY&gt; &lt;sub_policy&gt;</code>      </p>
<p>The configtxgen tool creates default policies as follows:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/Channel/Readers : ImplicitMetaPolicy <span class="keyword">for</span> ANY of /Channel/*/Readers</div><div class="line">/Channel/Writers : ImplicitMetaPolicy <span class="keyword">for</span> ANY of /Channel/*/Writers</div><div class="line">/Channel/Admins  : ImplicitMetaPolicy <span class="keyword">for</span> MAJORITY of /Channel/*/Admins</div><div class="line"></div><div class="line">/Channel/Application/Readers : ImplicitMetaPolicy <span class="keyword">for</span> ANY of /Channel/Application/*/Readers</div><div class="line">/Channel/Application/Writers : ImplicitMetaPolicy <span class="keyword">for</span> ANY of /Channel/Application/*/Writers</div><div class="line">/Channel/Application/Admins  : ImplicitMetaPolicy <span class="keyword">for</span> MAJORITY of /Channel/Application/*/Admins</div><div class="line"></div><div class="line">/Channel/Orderer/Readers : ImplicitMetaPolicy <span class="keyword">for</span> ANY of /Channel/Orderer/*/Readers</div><div class="line">/Channel/Orderer/Writers : ImplicitMetaPolicy <span class="keyword">for</span> ANY of /Channel/Orderer/*/Writers</div><div class="line">/Channel/Orderer/Admins  : ImplicitMetaPolicy <span class="keyword">for</span> MAJORITY of /Channel/Orderer/*/Admins</div><div class="line"></div><div class="line"><span class="comment"># Here * represents either Orderer, or Application, and this is repeated for each org</span></div><div class="line">/Channel/*/Org/Readers : SignaturePolicy <span class="keyword">for</span> 1 of MSP Principal Org Member</div><div class="line">/Channel/*/Org/Writers : SignaturePolicy <span class="keyword">for</span> 1 of MSP Principal Org Member</div><div class="line">/Channel/*/Org/Admins  : SignaturePolicy <span class="keyword">for</span> 1 of MSP Principal Org Admin</div></pre></td></tr></table></figure></p>
<h1 id="Channel-Configuration-（configtx）"><a href="#Channel-Configuration-（configtx）" class="headerlink" title="Channel Configuration （configtx）"></a>Channel Configuration （configtx）</h1><p>Channel Configuration 具有以下三个特性：字段有版本信息、修改有权限（mod_policy）、层级<br>Channel Configuration 定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">message Config &#123;</div><div class="line">    uint64 sequence = 1;</div><div class="line">    ConfigGroup channel_group = 2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 channel_group 即为配置树的根， 类型为 ConfigGroup：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">message ConfigGroup &#123;</div><div class="line">    <span class="keyword">uint64</span> version = <span class="number">1</span>;</div><div class="line">    <span class="keyword">map</span>&lt;<span class="keyword">string</span>,ConfigGroup&gt; groups = <span class="number">2</span>;</div><div class="line">    <span class="keyword">map</span>&lt;<span class="keyword">string</span>,ConfigValue&gt; values = <span class="number">3</span>;</div><div class="line">    <span class="keyword">map</span>&lt;<span class="keyword">string</span>,ConfigPolicy&gt; policies = <span class="number">4</span>;</div><div class="line">    <span class="keyword">string</span> mod_policy = <span class="number">5</span>;  <span class="comment">// 修改 ConfigGroup 内这几个字典的权限</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 ConfigValue, ConfigPolicy 类型也都有 mod_policy 字段以及 version 字段：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">message ConfigValue &#123;</div><div class="line">    <span class="keyword">uint64</span> version = <span class="number">1</span>;</div><div class="line">    bytes value = <span class="number">2</span>;</div><div class="line">    <span class="keyword">string</span> mod_policy = <span class="number">3</span>; </div><div class="line">&#125;</div><div class="line"></div><div class="line">message ConfigPolicy &#123;</div><div class="line">    <span class="keyword">uint64</span> version = <span class="number">1</span>;</div><div class="line">    Policy policy = <span class="number">2</span>;</div><div class="line">    <span class="keyword">string</span> mod_policy = <span class="number">3</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中 <code>mod_policy</code> 值为字符串，采用路径的表示方式，例如：<code>policy1</code> 表示当前 level 的 policies 字典中对应名字的权限，而 <code>Org1/policy2</code> 为相对路径，即向下一层中 Org1 中的 policies 中名字为 policy2 的权限。而 <code>/Channel/policy3</code> 为绝对路径，表示根下 policies 中名字为 policy3 的权限。       </p>
<p>在各层的 ConfigGroup 中，在 policies 字典中一般会定义名为：<code>Admins</code>，<code>Writers</code>，<code>Readers</code> 这几个权限            </p>
<p>一般来说，对于系统链，<code>channel_group</code> 这个根下面的 <code>groups</code> 字典包含 <code>Consortiums</code> 和 <code>Orderer</code>。而用户自定义链的 <code>channel_group</code> 中的 <code>groups</code> 包括 <code>Application</code> 和 <code>Orderer</code>（等同于系统链配置中的 Orderer 配置）。         </p>
<p><code>Application</code>: Application configuration is for channels which are designed for application type transactions. 即用户业务链（自定义链）的配置。         </p>
<p>用户链还需要指定 <code>Consortium</code> 这个字符串，取自系统链中 <code>Consortiums</code> 中的一个。且 <code>Application</code> 下定义的参与该业务的组织必须是该财团的子集。       </p>
<h1 id="业务-Channel-创建流程"><a href="#业务-Channel-创建流程" class="headerlink" title="业务 Channel 创建流程"></a>业务 Channel 创建流程</h1><p>When the orderer receives a CONFIG_UPDATE for a channel which does not exist, the orderer assumes that this must be a channel creation request and performs the following.</p>
<ol>
<li>The orderer identifies the consortium which the channel creation request is to be performed for. It does this by looking at the Consortium value of the top level group.</li>
<li>The orderer verifies that the organizations included in the Application group are a subset of the organizations included in the corresponding consortium and that the ApplicationGroup is set to version 1.</li>
<li>The orderer verifies that if the consortium has members, that the new channel also has application members (creation consortiums and channels with no members is useful for testing only).</li>
<li>The orderer creates a template configuration by taking the Orderer group from the ordering system channel, and creating an Application group with the newly specified members and specifying its mod_policy to be the ChannelCreationPolicy as specified in the consortium config. Note that the policy is evaluated in the context of the new configuration, so a policy requiring ALL members, would require signatures from all the new channel members, not all the members of the consortium.</li>
<li>The orderer then applies the CONFIG_UPDATE as an update to this template configuration. Because the CONFIG_UPDATE applies modifications to the Application group (its version is 1), the config code validates these updates against the ChannelCreationPolicy. If the channel creation contains any other modifications, such as to an individual org’s anchor peers, the corresponding mod policy for the element will be invoked.</li>
<li>The new CONFIG transaction with the new channel config is wrapped and sent for ordering on the ordering system channel. After ordering, the channel is created.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Profile encodes orderer/application configuration combinations for the</span></div><div class="line"><span class="comment">// configtxgen tool.</span></div><div class="line"><span class="keyword">type</span> Profile <span class="keyword">struct</span> &#123;</div><div class="line">	Consortium   <span class="keyword">string</span>                 <span class="string">`yaml:"Consortium"`</span></div><div class="line">	Application  *Application           <span class="string">`yaml:"Application"`</span></div><div class="line">	Orderer      *Orderer               <span class="string">`yaml:"Orderer"`</span></div><div class="line">	Consortiums  <span class="keyword">map</span>[<span class="keyword">string</span>]*Consortium <span class="string">`yaml:"Consortiums"`</span></div><div class="line">	Capabilities <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>        <span class="string">`yaml:"Capabilities"`</span></div><div class="line">	Policies     <span class="keyword">map</span>[<span class="keyword">string</span>]*Policy     <span class="string">`yaml:"Policies"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Profile</code> 这是封装系统链，用户链配置的结构体。 系统链（orderer链）和用户链分别设置该结构体的几个字段。      </p>
<p><code>func NewChannelGroup(conf *genesisconfig.Profile) (*cb.ConfigGroup, error) {}</code> 该方法将 <code>Profile</code> 转化为 <code>ConfigGroup</code>，需要注意由于 <code>Profile</code> 只是定义了 <code>Policy</code>，但除了 <code>Application</code> 里面的 <code>ACL</code>，并没有设置使用那个 policy，例如 mod_policy，CreateChannel 的 policy 等。 因此在 <code>NewChannelGroup</code> 这个函数中，会默认（模板）设置这些 policy，比如所有的 mod_policy 都是 Admins，Consortiums 中的 ChannelCreationPolicy 为 ANY of Admins of Org。这些都是用 <code>configtxgen</code> 这个工具默认配置的，该工具目前不提供其他的配置，需要我们修改代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Application encodes the application-level configuration needed in config</span></div><div class="line"><span class="comment">// transactions.</span></div><div class="line"><span class="keyword">type</span> Application <span class="keyword">struct</span> &#123;</div><div class="line">	Organizations []*Organization    <span class="string">`yaml:"Organizations"`</span></div><div class="line">	Capabilities  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>    <span class="string">`yaml:"Capabilities"`</span></div><div class="line">	Resources     *Resources         <span class="string">`yaml:"Resources"`</span></div><div class="line">	Policies      <span class="keyword">map</span>[<span class="keyword">string</span>]*Policy <span class="string">`yaml:"Policies"`</span></div><div class="line">	ACLs          <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>  <span class="string">`yaml:"ACLs"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="MSP-类型"><a href="#MSP-类型" class="headerlink" title="MSP 类型"></a>MSP 类型</h1><p>目前的 msp 类型有 <code>client</code> 和 <code>peer</code>，其中 client 表示应用端用户（user 或 admin），用于发送交易、查询等服务。而 peer 表示节点身份，用于背书，commit 验证。<br>这个是靠证书中的 <code>OU</code> 字段配置的，即 <code>Organization Unit</code>        </p>
<h1 id="背书策略"><a href="#背书策略" class="headerlink" title="背书策略"></a>背书策略</h1><p><code>MSP.ROLE</code>，其中 ROLE 为 member/admin/client/peer<br><code>memeber</code>: 包括 client 和 peer<br><code>admin</code>: 特指 client 中的 admin    </p>
<h1 id="Idemix"><a href="#Idemix" class="headerlink" title="Idemix"></a>Idemix</h1><p>目前在 Fabric 1.2 中，定义了三种 MSP 类型：<code>FABRIC</code>，<code>IDEMIX</code>，<code>OTHER</code>，目前代码运行时只支持第一种。 其中 <code>FABRIC</code> 即为 <code>BccspMsp (bsscp is the crypto provider)</code>，第二种为 <code>IdemixMsp</code></p>
<h1 id="Block-的结构"><a href="#Block-的结构" class="headerlink" title="Block 的结构"></a>Block 的结构</h1><p>其实可以去看 vscc 的代码（core/handlers），那里会解析 block 直到每条交易信息<br>Block.Data.Data 是 [][]byte 类型，是交易字节流的列表。<br>例如取第一条交易 Block.Data.Data[0]，可以 Unmarshal 为 common.Envelope<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Envelope wraps a Payload with a signature so that the message may be authenticated</span></div><div class="line"><span class="keyword">type</span> Envelope <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// A marshaled Payload</span></div><div class="line">	Payload []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=payload,proto3" json:"payload,omitempty"`</span></div><div class="line">    <span class="comment">// A signature by the creator specified in the Payload header</span></div><div class="line">    <span class="comment">// 对 Payload 字段内容的签名，必须采用与 Payload 中 header.SignatureHeader 中的 Creator 相同的身份</span></div><div class="line">	Signature []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=signature,proto3" json:"signature,omitempty"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Envelope.Payload 可以 Unmarshal 为 common.Payload<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Payload is the message contents (and header to allow for signing)</span></div><div class="line"><span class="keyword">type</span> Payload <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="comment">// Header is included to provide identity and prevent replay</span></div><div class="line">    </div><div class="line">	Header *Header <span class="string">`protobuf:"bytes,1,opt,name=header" json:"header,omitempty"`</span></div><div class="line">	<span class="comment">// Data, the encoding of which is defined by the type in the header</span></div><div class="line">	Data []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=data,proto3" json:"data,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// common.Header</span></div><div class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123;</div><div class="line">    ChannelHeader   []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=channel_header,json=channelHeader,proto3" json:"channel_header,omitempty"`</span></div><div class="line">	SignatureHeader []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=signature_header,json=signatureHeader,proto3" json:"signature_header,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> SignatureHeader <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Creator of the message, a marshaled msp.SerializedIdentity</span></div><div class="line">	Creator []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=creator,proto3" json:"creator,omitempty"`</span></div><div class="line">	<span class="comment">// Arbitrary number that may only be used once. Can be used to detect replay attacks.</span></div><div class="line">	Nonce []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=nonce,proto3" json:"nonce,omitempty"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而 Payload.Data 可以 Unmarshal 为 peer.Transaction<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Transaction <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// The payload is an array of TransactionAction. An array is necessary to</span></div><div class="line">    <span class="comment">// accommodate multiple actions per transaction</span></div><div class="line">    <span class="comment">// 其实只有一个元素</span></div><div class="line">	Actions []*TransactionAction <span class="string">`protobuf:"bytes,1,rep,name=actions" json:"actions,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransactionAction binds a proposal to its action.  The type field in the</span></div><div class="line"><span class="comment">// header dictates the type of action to be applied to the ledger.</span></div><div class="line"><span class="keyword">type</span> TransactionAction <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="comment">// The header of the proposal action, which is the proposal header</span></div><div class="line">    <span class="comment">// 这里的 Header 等同于 SignatureHeader，直接拷贝过去的</span></div><div class="line">	Header []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=header,proto3" json:"header,omitempty"`</span></div><div class="line">	<span class="comment">// The payload of the action as defined by the type in the header For</span></div><div class="line">	<span class="comment">// chaincode, it's the bytes of ChaincodeActionPayload</span></div><div class="line">	Payload []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=payload,proto3" json:"payload,omitempty"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TransactionAction.Payload 可以 Unmarshal 为 peer.ChaincodeActionPayload<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ChaincodeActionPayload is the message to be used for the TransactionAction's</span></div><div class="line"><span class="comment">// payload when the Header's type is set to CHAINCODE.  It carries the</span></div><div class="line"><span class="comment">// chaincodeProposalPayload and an endorsed action to apply to the ledger.</span></div><div class="line"><span class="keyword">type</span> ChaincodeActionPayload <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// This field contains the bytes of the ChaincodeProposalPayload message from</span></div><div class="line">	<span class="comment">// the original invocation (essentially the arguments) after the application</span></div><div class="line">	<span class="comment">// of the visibility function. The main visibility modes are "full" (the</span></div><div class="line">	<span class="comment">// entire ChaincodeProposalPayload message is included here), "hash" (only</span></div><div class="line">	<span class="comment">// the hash of the ChaincodeProposalPayload message is included) or</span></div><div class="line">	<span class="comment">// "nothing".  This field will be used to check the consistency of</span></div><div class="line">	<span class="comment">// ProposalResponsePayload.proposalHash.  For the CHAINCODE type,</span></div><div class="line">	<span class="comment">// ProposalResponsePayload.proposalHash is supposed to be H(ProposalHeader ||</span></div><div class="line">	<span class="comment">// f(ChaincodeProposalPayload)) where f is the visibility function.</span></div><div class="line">	ChaincodeProposalPayload []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=chaincode_proposal_payload,json=chaincodeProposalPayload,proto3" json:"chaincode_proposal_payload,omitempty"`</span></div><div class="line">	<span class="comment">// The list of actions to apply to the ledger</span></div><div class="line">	Action *ChaincodeEndorsedAction <span class="string">`protobuf:"bytes,2,opt,name=action" json:"action,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">其中第一个字段：</div><div class="line"><span class="comment">// ChaincodeProposalPayload is the Proposal's payload message to be used when</span></div><div class="line"><span class="comment">// the Header's type is CHAINCODE.  It contains the arguments for this</span></div><div class="line"><span class="comment">// invocation.</span></div><div class="line"><span class="keyword">type</span> ChaincodeProposalPayload <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Input contains the arguments for this invocation. If this invocation</span></div><div class="line">	<span class="comment">// deploys a new chaincode, ESCC/VSCC are part of this field.</span></div><div class="line">	<span class="comment">// This is usually a marshaled ChaincodeInvocationSpec</span></div><div class="line">	Input []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=input,proto3" json:"input,omitempty"`</span></div><div class="line">	<span class="comment">// TransientMap contains data (e.g. cryptographic material) that might be used</span></div><div class="line">	<span class="comment">// to implement some form of application-level confidentiality. The contents</span></div><div class="line">	<span class="comment">// of this field are supposed to always be omitted from the transaction and</span></div><div class="line">	<span class="comment">// excluded from the ledger.</span></div><div class="line">	TransientMap <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,rep,name=TransientMap" json:"TransientMap,omitempty" protobuf_key:"bytes,1,opt,name=key" protobuf_val:"bytes,2,opt,name=value,proto3"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">第二个字段：</div><div class="line"><span class="comment">// ChaincodeEndorsedAction carries information about the endorsement of a</span></div><div class="line"><span class="comment">// specific proposal</span></div><div class="line"><span class="keyword">type</span> ChaincodeEndorsedAction <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// This is the bytes of the ProposalResponsePayload message signed by the</span></div><div class="line">	<span class="comment">// endorsers.  Recall that for the CHAINCODE type, the</span></div><div class="line">	<span class="comment">// ProposalResponsePayload's extenstion field carries a ChaincodeAction</span></div><div class="line">	ProposalResponsePayload []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=proposal_response_payload,json=proposalResponsePayload,proto3" json:"proposal_response_payload,omitempty"`</span></div><div class="line">	<span class="comment">// The endorsement of the proposal, basically the endorser's signature over</span></div><div class="line">	<span class="comment">// proposalResponsePayload</span></div><div class="line">	Endorsements []*Endorsement <span class="string">`protobuf:"bytes,2,rep,name=endorsements" json:"endorsements,omitempty"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">其中 Endorsement</div><div class="line"><span class="keyword">type</span> Endorsement <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="comment">// Identity of the endorser (e.g. its certificate)</span></div><div class="line">    <span class="comment">// 可以解析说 msp 身份</span></div><div class="line">	Endorser []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=endorser,proto3" json:"endorser,omitempty"`</span></div><div class="line">	<span class="comment">// Signature of the payload included in ProposalResponse concatenated with</span></div><div class="line">    <span class="comment">// the endorser's certificate; ie, sign(ProposalResponse.payload + endorser)</span></div><div class="line">    <span class="comment">// 对外部 ProposalResponsePayload + endorser 的签名（因为懒得再构建结构体包含这两项了）</span></div><div class="line">	Signature []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=signature,proto3" json:"signature,omitempty"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="peer-收到-Proposal-后是如何验证交易的发起方是否在-channel-对应的-orgs-中"><a href="#peer-收到-Proposal-后是如何验证交易的发起方是否在-channel-对应的-orgs-中" class="headerlink" title="peer 收到 Proposal 后是如何验证交易的发起方是否在 channel 对应的 orgs 中"></a>peer 收到 Proposal 后是如何验证交易的发起方是否在 channel 对应的 orgs 中</h1><p>peer 首先会收到 <code>*pb.SignedProposal</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> SignedProposal <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// The bytes of Proposal</span></div><div class="line">	ProposalBytes []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=proposal_bytes,json=proposalBytes,proto3" json:"proposal_bytes,omitempty"`</span></div><div class="line">	<span class="comment">// Signaure over proposalBytes; this signature is to be verified against</span></div><div class="line">	<span class="comment">// the creator identity contained in the header of the Proposal message</span></div><div class="line">	<span class="comment">// marshaled as proposalBytes</span></div><div class="line">	Signature []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=signature,proto3" json:"signature,omitempty"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SignedProposal.ProposalBytes 可以被 Unmarshal 为 <code>peer.Proposal</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Proposal <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// The header of the proposal. It is the bytes of the Header</span></div><div class="line">	Header []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,1,opt,name=header,proto3" json:"header,omitempty"`</span></div><div class="line">	<span class="comment">// The payload of the proposal as defined by the type in the proposal</span></div><div class="line">	<span class="comment">// header.</span></div><div class="line">	Payload []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,2,opt,name=payload,proto3" json:"payload,omitempty"`</span></div><div class="line">	<span class="comment">// Optional extensions to the proposal. Its content depends on the Header's</span></div><div class="line">	<span class="comment">// type field.  For the type CHAINCODE, it might be the bytes of a</span></div><div class="line">	<span class="comment">// ChaincodeAction message.</span></div><div class="line">	Extension []<span class="keyword">byte</span> <span class="string">`protobuf:"bytes,3,opt,name=extension,proto3" json:"extension,omitempty"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中 Proposal.Header 正好是 Unmarshal 为 <code>common.Header</code>（前面介绍了)。其中的 Header.SignatureHeader.Creator 记录了交易发起者的身份。</p>
<p>peer 中每个 channel 都有个 mspmgr 对象，内部有一个 map<mspid><msp> ，key 为该 channel 中加入组织的 MSPID，peer 首先从 Header.SignatureHeader.Creator 反序列化为 <code>msp.SerializedIdentity</code>，从该对象中获取该交易发起者的 MSPID，通过查询 mspmgr 中的 map，如果存在，表示在交易允许组织范围内。然后根据的该 map 对应 key 的 value，即 MSP 对象。调用 MSP.deserializeIdentityInternal(SerializedIdentity.IdBytes) 获取对应的 <code>Identity</code> 对象。然后调用该对象的 <code>Validate</code> 方法判断其是否是对应组织根证书签发的证书。最后用该对象的 <code>Verify(msg []byte, sig []byte) error</code> 方法验证 <code>SignedProposal</code> 的 Signature 是否正确。（即这个签名为 Creator，且 Creator 在对应组织列表内）        </msp></mspid></p>
<hr>
<p>一个 MSP 对象代表一个身份。其中 MSP 有个 Setup 接口，例如 <code>bccspmsp</code> 的 Setup 接受该组织的 <code>Name</code>, <code>RootCerts</code>, <code>IntermediateCerts</code>, <code>Admins</code>, <code>RevocationList</code> 等信息。 因此 MSP 中会保存该身份所属的组织 MSPID 以及信任的根证书等信息。<br><code>MSP.GetDefaultSigningIdentity() (SigningIdentity, error)</code>：获取该 MSP 对象中已经保存的默认的身份（SigningIdentity），即成员身份。    </p>
<p><code>MSP.DeserializeIdentity(serializedIdentity []byte) (Identity, error)</code>：可以从字符串中解析出身份 Identity，前提是其 mspid 与 msp 中的 mspid 一致。（即只能反序列化同一个组织的身份，否则返回错误。但要注意这里不会验证该身份是否由 msp 信任的根证书或中间证书签发）        </p>
<p><code>MSP.Validate(id Identity) error</code>：这里才会验证传入的身份是否真的由该 msp 中信任的根证书/中间证书签发。<br>MSP 可以返回自身的 <code>SigningIdentity</code>，或者解析出同组织成员的 <code>Identity</code>。这两个类型的<code>区别</code>：       </p>
<ol>
<li><code>Identity</code> 可以用来验证签名信息，获取 mspid，过期时间，序列号和判断是否满足背书策略，判断该身份是否有效，如下：<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IsValid returns nil if this instance is a valid identity or an error otherwise</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(id *identity)</span> <span class="title">Validate</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// 对于从 MSP 中解析中的 Identity，其 Validate 就是调用 MSP.Validate 方法。</span></div><div class="line">	<span class="keyword">return</span> id.msp.Validate(id)</div><div class="line">&#125;</div><div class="line"><span class="string">``</span><span class="string">`      </span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">2. `</span>SigningIdentity<span class="string">` 继承 Identity 所有方法，同时由于带有私钥信息，可以用来签名。        </span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string"># 可插拔的 endorsement 和 validation</span></div><div class="line"><span class="string">新版的 `</span>core.yaml<span class="string">` 中可以配置一系列的动态链接库形式的 endorsement 实现和 validation 实现。方便用户在不更改 fabric 代码的前提下使用自定义的实现。 定义在 `</span>peer.handlers<span class="string">` 中。</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">`</span><span class="string">``</span> yaml</div><div class="line">	handlers:</div><div class="line"></div><div class="line">		# authFilters 是个列表，会被依次按顺序执行</div><div class="line">        authFilters:</div><div class="line">          -</div><div class="line">            name: DefaultAuth</div><div class="line">          -</div><div class="line">            name: ExpirationCheck    # This filter checks identity x509 certificate expiration</div><div class="line">        decorators:</div><div class="line">          -</div><div class="line">			name: DefaultDecorator</div><div class="line">		</div><div class="line">		# endorsers 是一个 <span class="keyword">map</span>，合约初始化的时候需要指定对应的 key，表示其使用的 endorsement 实现。</div><div class="line">		# 例如 escc 这个 key，其 library 为空，表示不是动态库，而是定义在代码中 core/handlers/library/library.<span class="keyword">go</span> 中的 HandlerLibrary 这个结构体的 DefaultEndorsement 方法返回的对象</div><div class="line">        endorsers:</div><div class="line">          escc:</div><div class="line">            name: DefaultEndorsement</div><div class="line">			library:</div><div class="line">		# 类似于 endorsers，我们必须把后续可能会用到的 validators 实现都定义上，因为在 peer 启动时，会调用 Register 这对象读取配置文件，加载所有 handlers，供后续调用。</div><div class="line">		# 注意：不会运行所有的 validators，而是运行合约初始化指定的 validator</div><div class="line">        validators:</div><div class="line">          vscc:</div><div class="line">            name: DefaultValidation</div><div class="line">            library:</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="财团-Consortium-中的成员作用"><a href="#财团-Consortium-中的成员作用" class="headerlink" title="财团 Consortium 中的成员作用"></a>财团 Consortium 中的成员作用</h1><p><strong>只有存在于对应财团中的成员组织的管理员，才可以创建属于该财团的通道</strong>       </p>
<p><strong>但是通道创建完毕后，可以通过更新的方式向该通道添加非财团的组织，但是该组织仍然是无法创建该财团的通道</strong><br><strong>通道内的所有组织都可以发送交易，即使他们不在 orderer 的财团内</strong></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-multi-stage-build-support"><span class="toc-number">1.</span> <span class="toc-text">docker multi-stage build support</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Service-Discovery"><span class="toc-number">2.</span> <span class="toc-text">Service Discovery</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Private-Data"><span class="toc-number">3.</span> <span class="toc-text">Private Data</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新的-event-机制"><span class="toc-number">4.</span> <span class="toc-text">新的 event 机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新的-transaction-flow"><span class="toc-number">5.</span> <span class="toc-text">新的 transaction flow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ACL-access-control-list"><span class="toc-number">6.</span> <span class="toc-text">ACL access control list</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Channel-Configuration-（configtx）"><span class="toc-number">7.</span> <span class="toc-text">Channel Configuration （configtx）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#业务-Channel-创建流程"><span class="toc-number">8.</span> <span class="toc-text">业务 Channel 创建流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MSP-类型"><span class="toc-number">9.</span> <span class="toc-text">MSP 类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#背书策略"><span class="toc-number">10.</span> <span class="toc-text">背书策略</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Idemix"><span class="toc-number">11.</span> <span class="toc-text">Idemix</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Block-的结构"><span class="toc-number">12.</span> <span class="toc-text">Block 的结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#peer-收到-Proposal-后是如何验证交易的发起方是否在-channel-对应的-orgs-中"><span class="toc-number">13.</span> <span class="toc-text">peer 收到 Proposal 后是如何验证交易的发起方是否在 channel 对应的 orgs 中</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#财团-Consortium-中的成员作用"><span class="toc-number">14.</span> <span class="toc-text">财团 Consortium 中的成员作用</span></a></li></ol>
    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Landleany
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


